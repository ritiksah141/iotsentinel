# IoTSentinel Database Schema

Complete SQLite database schema for IoTSentinel network security monitor.

## Overview

The database uses 4 main tables with foreign key relationships:

- **devices**: All devices seen on network
- **connections**: Network flows captured by Zeek
- **alerts**: Security alerts generated by ML models
- **ml_predictions**: ML model predictions for each connection

## Complete Schema

### `devices` Table

Stores information about network devices.

```sql
CREATE TABLE devices (
    device_ip TEXT PRIMARY KEY,         -- Device IP address
    device_name TEXT,                   -- Friendly name (user-editable)
    device_type TEXT,                   -- Type: Laptop, Phone, IoT, etc.
    mac_address TEXT,                   -- MAC address
    manufacturer TEXT,                  -- Manufacturer (from MAC OUI)
    first_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_trusted INTEGER DEFAULT 0,      -- 0=unknown, 1=trusted
    is_blocked INTEGER DEFAULT 0        -- 0=allowed, 1=blocked
);
```

**Indexes:** PRIMARY KEY on `device_ip`

### `connections` Table

Stores network connections parsed from Zeek logs.

```sql
CREATE TABLE connections (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    device_ip TEXT NOT NULL,            -- Source device
    dest_ip TEXT,                       -- Destination IP
    dest_port INTEGER,                  -- Destination port
    protocol TEXT,                      -- tcp, udp, icmp
    service TEXT,                       -- http, https, dns (from Zeek)
    duration REAL,                      -- Connection duration (seconds)
    bytes_sent INTEGER DEFAULT 0,
    bytes_received INTEGER DEFAULT 0,
    packets_sent INTEGER DEFAULT 0,
    packets_received INTEGER DEFAULT 0,
    conn_state TEXT,                    -- Zeek connection state (SF, S0, etc.)
    processed INTEGER DEFAULT 0,        -- 0=needs ML, 1=processed
    FOREIGN KEY (device_ip) REFERENCES devices(device_ip)
);
```

**Indexes:**

- PRIMARY KEY on `id`
- INDEX on `timestamp` (for time-range queries)
- INDEX on `device_ip` (for per-device queries)
- INDEX on `processed` (for ML batch processing)

### `alerts` Table

Stores security alerts generated when anomalies detected.

```sql
CREATE TABLE alerts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    device_ip TEXT NOT NULL,
    severity TEXT CHECK(severity IN ('low', 'medium', 'high', 'critical')),
    anomaly_score REAL,                 -- Anomaly score from ML model
    explanation TEXT,                   -- Plain English explanation
    top_features TEXT,                  -- JSON: {"feature": value, ...}
    acknowledged INTEGER DEFAULT 0,     -- 0=new, 1=acknowledged
    acknowledged_at TIMESTAMP,
    FOREIGN KEY (device_ip) REFERENCES devices(device_ip)
);
```

**Indexes:**

- PRIMARY KEY on `id`
- INDEX on `timestamp` (for recent alerts queries)
- INDEX on `device_ip` (for per-device alerts)

### `ml_predictions` Table

Stores ML model predictions for audit trail and analysis.

```sql
CREATE TABLE ml_predictions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    connection_id INTEGER,
    is_anomaly INTEGER,                 -- 0=normal, 1=anomaly
    anomaly_score REAL,
    model_type TEXT,                    -- autoencoder, isolation_forest
    model_version TEXT,                 -- v1, v2, etc.
    FOREIGN KEY (connection_id) REFERENCES connections(id)
);
```

**Indexes:**

- PRIMARY KEY on `id`
- INDEX on `connection_id` (for connection lookup)
- INDEX on `timestamp` (for time-based analysis)

## Design Rationale

### Why `packets_sent` / `packets_received`?

**Purpose:** Essential features for ML anomaly detection.

**Source:** Zeek's `conn.log` provides these as `orig_pkts` and `resp_pkts`.

**Usage in ML:**

```python
# Feature extractor uses these
df['total_packets'] = df['packets_sent'] + df['packets_received']
df['packet_rate'] = df['total_packets'] / df['duration']
```

### Why `device_type` / `manufacturer`?

**Purpose:** Better user experience in dashboard.

**Example:**

```
Instead of: "192.168.1.50"
Show:       "Samsung Smart TV (192.168.1.50)"
```

**Future:** Can be auto-detected using DHCP fingerprinting or MAC OUI lookup.

### Why `is_blocked` flag?

**Purpose:** Future feature for blocking malicious devices at router level.

**Workflow:**

```
User clicks "Block Device" → Set is_blocked=1 → Router ACL updated
```

### Why `processed` flag in connections?

**Purpose:** Efficient batch processing by ML engine.

**Workflow:**

```sql
-- ML engine gets unprocessed connections
SELECT * FROM connections WHERE processed = 0 LIMIT 100;

-- Process through ML model
-- ...

-- Mark as processed
UPDATE connections SET processed = 1 WHERE id IN (...);
```

This prevents re-processing same connections and allows ML engine to catch up if it falls behind.

## Sample Queries

### Get device with most connections

```sql
SELECT
    d.device_name,
    COUNT(*) as conn_count
FROM connections c
JOIN devices d ON c.device_ip = d.device_ip
WHERE c.timestamp > datetime('now', '-24 hours')
GROUP BY d.device_ip
ORDER BY conn_count DESC
LIMIT 10;
```

### Get devices with alerts

```sql
SELECT
    d.device_ip,
    d.device_name,
    COUNT(a.id) as alert_count,
    MAX(a.severity) as max_severity
FROM devices d
JOIN alerts a ON d.device_ip = a.device_ip
WHERE a.timestamp > datetime('now', '-24 hours')
GROUP BY d.device_ip
ORDER BY alert_count DESC;
```

### Get anomaly rate over time

```sql
SELECT
    DATE(timestamp) as date,
    COUNT(*) as total,
    SUM(is_anomaly) as anomalies,
    CAST(SUM(is_anomaly) AS FLOAT) / COUNT(*) * 100 as anomaly_rate
FROM ml_predictions
WHERE timestamp > datetime('now', '-7 days')
GROUP BY date
ORDER BY date;
```

## Maintenance

### Vacuum Database

```bash
sqlite3 data/database/iotsentinel.db "VACUUM;"
```

### Check Database Size

```bash
ls -lh data/database/iotsentinel.db
```

### Backup Database

```bash
sqlite3 data/database/iotsentinel.db ".backup data/backups/iotsentinel_$(date +%Y%m%d).db"
```

### Clean Old Data

```sql
-- Delete connections older than 30 days
DELETE FROM connections WHERE timestamp < datetime('now', '-30 days');

-- Delete alerts older than 90 days
DELETE FROM alerts WHERE timestamp < datetime('now', '-90 days');

-- Vacuum to reclaim space
VACUUM;
```
